#####
# Circle CI
# 
# For running docker images on circle ci, see: https://circleci.com/docs/docker
# For circle.yml explanation, see: https://circleci.com/docs/manually
# Python specific configuration, see: https://circleci.com/docs/language-python
#####


machine:
    services:
        - docker
    pre:
      - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0

dependencies:
    pre:
        # Remove services which will conflict
        - sudo killall postgres
        - docker info
        - git clone https://github.com/docker-library/official-images.git ~/official-images
        - npm install -g npm
        - sudo apt-get install nodejs
        - pip install docker-compose


# Run django tests, polymer tests
# TODO: Deployment test (build and tag / run / destroy)
test:
    pre:
      - docker-compose -f config/test.yml up -d
      # Docker Images: Copy all tests into official folder and combine configs
      - sudo cp -r tests/* ~/official-images/test/tests
      - docker login -e "$DOCKER_EMAIL" -u "$DOCKER_USER" -p "$DOCKER_PASS"
      - docker-compose -f config/test.yml ps
      - docker tag tetherbox_app "$APP_TEST_IMAGE"
      #- docker push "$APP_TEST_IMAGE"
      - ~/official-images/test/run.sh --config ~/official-images/test/config.sh --config /app/tests/config.sh "config_app_1"
      # TODO: Deployment test
    override:
      # Django Tests for Blog, Search & Accounts (Need to manually add to the end of this command)
      # Need to save junit results inside app within docker container then copy to CIRCLE_TEST_REPORTS
      - docker-compose -f config/test.yml run app sh -c "mkdir -p circle-junit/django && py.test --junitxml=circle-junit/django/junit.xml apps/blog apps/search apps/accounts"
      - mkdir -p $CIRCLE_TEST_REPORTS/django
      - mv /home/ubuntu/codewheel-backend/app/app/circle-junit/django $CIRCLE_TEST_REPORTS/


